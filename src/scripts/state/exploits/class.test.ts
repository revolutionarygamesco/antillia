import { type ExploitRecordData } from './data.ts'
import ExploitRecord from './class.ts'

const sample: ExploitRecordData = {
  id: 'abc',
  exploits: [
    ['Original 1', 'Mutated 1.1'],
    ['Original 2']
  ]
}

describe('ExploitRecord', () => {
  describe('constructor', () => {
    it('returns an exploit record', () => {
      expect(new ExploitRecord()).toBeInstanceOf(ExploitRecord)
    })

    it('starts empty', () => {
      const record = new ExploitRecord()
      expect(record.exploits).toHaveLength(0)
    })

    it('can take existing data', () => {
      const record = new ExploitRecord(sample)
      expect(record.exploits).toHaveLength(2)
    })
  })

  describe('Instance methods', () => {
    describe('toObject', () => {
      it('returns an object', () => {
        const record = new ExploitRecord()
        const actual = record.toObject()

        expect(actual.id).toBe(record.id)
      })
    })

    describe('serialize', () => {
      it('serializes crew state', () => {
        const record = new ExploitRecord()
        const actual = record.serialize()
        expect(actual).toContain(`{"id":"${record.id}"`)
      })
    })

    describe('getHistory', () => {
      it('returns the original form of each exploit', () => {
        const record = new ExploitRecord(sample)
        const actual = record.getHistory()
        expect(actual).toEqual(['Original 1', 'Original 2'])
      })
    })

    describe('getLegend', () => {
      it('returns the latest form of each exploit', () => {
        const record = new ExploitRecord(sample)
        const actual = record.getLegend()
        expect(actual).toEqual(['Mutated 1.1', 'Original 2'])
      })
    })
  })

  describe('Class methods', () => {
    describe('deserialize', () => {
      it('returns null if given an invalid string', () => {
        const actual = ExploitRecord.deserialize('lol nope')
        expect(actual).toBeNull()
      })

      it('deserializes crew state', () => {
        const before = new ExploitRecord()
        const actual = ExploitRecord.deserialize(before.serialize())
        expect(actual).toEqual(before)
      })
    })

    describe('check', () => {
      it('returns false if you roll greater than number of exploits', () => {
        const record = new ExploitRecord()
        expect(record.check(10)).toBe(false)
      })

      it('returns true if you roll less than the number of exploits', () => {
        const record = new ExploitRecord(sample)
        expect(record.check(1)).toBe(true)
      })

      it('returns true if you roll equal to the number of exploits', () => {
        const record = new ExploitRecord(sample)
        expect(record.check(sample.exploits.length)).toBe(true)
      })
    })
  })
})
