import generateID from '../../utilities/generate-id.ts'
import { type ExploitRecordData, isExploitRecordData } from './data.ts'
import selectRandomBetween from '../../random/between.ts'

class ExploitRecord {
  id: string
  exploits: string[][]

  constructor(data?: Partial<ExploitRecordData>) {
    this.id = typeof data?.id === 'string' ? data.id : generateID()
    this.exploits = data?.exploits ?? []
  }

  toObject (): ExploitRecordData {
    return {
      id: this.id,
      exploits: this.exploits
    }
  }

  serialize (): string {
    return JSON.stringify(this.toObject())
  }

  getHistory (): string[] {
    return this.exploits.map(exploit => exploit[0])
  }

  getLegend( ): string[] {
    return this.exploits.map(exploit => exploit[exploit.length - 1])
  }

  check (roll?: number): boolean {
    const r = roll ?? selectRandomBetween(1, 20)
    return r <= this.exploits.length
  }

  static deserialize(serialized: string): ExploitRecord | null {
    try {
      const data = JSON.parse(serialized)
      if (!isExploitRecordData(data)) return null
      return new ExploitRecord(data)
    } catch (_err) { return null }
  }
}

export default ExploitRecord
